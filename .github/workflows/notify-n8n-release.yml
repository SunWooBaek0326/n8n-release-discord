name: Notify n8n Releases to Discord

on:
  # ðŸ”” ë¦´ë¦¬ì¦ˆê°€ 'published' ë˜ëŠ” ì¦‰ì‹œ íŠ¸ë¦¬ê±° (ì‹¤ì‹œê°„)
  release:
    types: [published]
  # â± í´ë§(ë°±ì—…ìš©): 30ë¶„ë§ˆë‹¤ í™•ì¸ (UTC ê¸°ì¤€) â€” ì‹¤ì‹œê°„ ëˆ„ë½ ëŒ€ë¹„
  schedule:
    - cron: "*/30 * * * *"
  # â–¶ï¸ ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch: {}

permissions:
  contents: write   # .github/n8n_latest ì»¤ë°‹ìš© (ì¤‘ë³µ ë°©ì§€ ê¸°ë¡)

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      # 0) Webhook ì‹œí¬ë¦¿ í™•ì¸
      - name: Validate webhook secret
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "::error::Missing secret DISCORD_WEBHOOK_URL"
            exit 1
          fi

      # 1) Webhook ê°’ ì •ê·œí™” + í˜•ì‹ ì ê²€
      - name: Normalize webhook value
        id: hook
        run: |
          CLEAN=$(printf "%s" "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                  | tr -d '\r' | tr -d '\n' | xargs)
          case "$CLEAN" in
            https://discord.com/api/webhooks/*|https://discordapp.com/api/webhooks/*) : ;;
            *) echo "::error::Webhook URL looks invalid: $CLEAN"; exit 2 ;;
          esac
          echo "webhook=$CLEAN" >> $GITHUB_OUTPUT

      # 2) ì´ë²¤íŠ¸ ìœ í˜•ë³„ë¡œ ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¤€ë¹„
      #    - release ì´ë²¤íŠ¸: GitHub ì´ë²¤íŠ¸ íŽ˜ì´ë¡œë“œì—ì„œ ì§ì ‘ ì½ìŒ(ì‹¤ì‹œê°„)
      #    - schedule/workflow_dispatch: APIì—ì„œ ìµœì‹  ë¦´ë¦¬ì¦ˆ ì¡°íšŒ(í´ë§/ìˆ˜ë™)
      - name: Prepare release payload
        id: rel
        env:
          EVENT: ${{ github.event_name }}
        run: |
          set -e

          if [ "$EVENT" = "release" ]; then
            # ì‹¤ì‹œê°„: ì´ë²¤íŠ¸ íŽ˜ì´ë¡œë“œ ì‚¬ìš©
            TAG='${{ github.event.release.tag_name }}'
            TITLE='${{ github.event.release.name }}'
            URL='${{ github.event.release.html_url }}'
            DATE='${{ github.event.release.published_at }}'
            BODY_RAW='${{ github.event.release.body }}'
          else
            # í´ë§/ìˆ˜ë™: API ì¡°íšŒ
            RES=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases/latest)
            TAG=$(echo "$RES"   | jq -r .tag_name)
            TITLE=$(echo "$RES" | jq -r .name)
            URL=$(echo "$RES"   | jq -r .html_url)
            DATE=$(echo "$RES"  | jq -r .published_at)
            BODY_RAW=$(echo "$RES" | jq -r .body)
          fi

          # ë‚ ì§œ YYYY-MM-DD ë¡œ ê°„ë‹¨ í‘œê¸°
          DATE_SHORT=$(echo "$DATE" | cut -dT -f1)

          # Discord ìž„ë² ë“œ ì œí•œ ëŒ€ë¹„(ì„¤ëª… 1800ìž ì´ë‚´ë¡œ íŠ¸ë¦¼)
          BODY_TRIM=$(printf "%s" "$BODY_RAW" | head -c 1800)

          echo "tag=$TAG"         >> $GITHUB_OUTPUT
          echo "title=$TITLE"     >> $GITHUB_OUTPUT
          echo "url=$URL"         >> $GITHUB_OUTPUT
          echo "date=$DATE_SHORT" >> $GITHUB_OUTPUT
          echo "body=$BODY_TRIM"  >> $GITHUB_OUTPUT

      # 3) ì´ì „ì— ë³´ë‚¸ íƒœê·¸ ì½ê¸°(í´ë§/ìˆ˜ë™ì¼ ë•Œë§Œ ì¤‘ë³µ ë°©ì§€ì— ì‚¬ìš©)
      - name: Read previous tag
        id: prev
        run: |
          FILE=".github/n8n_latest"
          if [ -f "$FILE" ]; then PREV=$(cat "$FILE"); else PREV=""; fi
          echo "prev=$PREV" >> $GITHUB_OUTPUT

      # 4) ì „ì†¡ ëª¨ë“œ/ì¤‘ë³µ ì—¬ë¶€ ê²°ì •
      - name: Decide sending mode
        id: decide
        env:
          EVENT: ${{ github.event_name }}
          PREV:  ${{ steps.prev.outputs.prev }}
          CURR:  ${{ steps.rel.outputs.tag }}
        run: |
          # release ì´ë²¤íŠ¸ëŠ” ë¬´ì¡°ê±´ ì „ì†¡(ì‹¤ì‹œê°„)
          if [ "$EVENT" = "release" ]; then
            echo "mode=push" >> $GITHUB_OUTPUT
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # í´ë§/ìˆ˜ë™: ìƒˆ íƒœê·¸ì¼ ë•Œë§Œ ì „ì†¡
          CHANGED="false"
          [ "$PREV" != "$CURR" ] && CHANGED="true"

          MODE="auto"
          [ "$EVENT" = "workflow_dispatch" ] && MODE="manual"

          echo "mode=$MODE"     >> $GITHUB_OUTPUT
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # 5) Discord ì „ì†¡
      - name: Send to Discord
        if: steps.decide.outputs.changed == 'true'
        env:
          WEBHOOK: ${{ steps.hook.outputs.webhook }}
          TAG:     ${{ steps.rel.outputs.tag }}
          TITLE:   ${{ steps.rel.outputs.title }}
          URL:     ${{ steps.rel.outputs.url }}
          DATE:    ${{ steps.rel.outputs.date }}
          BODY:    ${{ steps.rel.outputs.body }}
        run: |
          set -e
          jq -n \
            --arg title "$TITLE" \
            --arg url   "$URL" \
            --arg desc  "**$TAG** released on $DATE\n\n$BODY" \
            '{embeds:[{title:$title, url:$url, description:$desc}]}' \
          | curl -sS -H "Content-Type: application/json" -d @- "$WEBHOOK" -w "\nHTTP %{http_code}\n"

      # 6) ê¸°ë¡ íŒŒì¼ ê°±ì‹ (ë³´ë‚¸ íƒœê·¸ ì €ìž¥)
      - name: Update last sent tag
        if: steps.decide.outputs.changed == 'true'
        run: |
          mkdir -p .github
          echo "${{ steps.rel.outputs.tag }}" > .github/n8n_latest
          git config user.name  "actions-bot"
          git config user.email "actions-bot@users.noreply.github.com"
          git add .github/n8n_latest
          git commit -m "chore: update latest n8n tag to ${{ steps.rel.outputs.tag }}" || echo "nothing to commit"
          git push || echo "no changes pushed"
