name: Notify n8n Releases to Telegram

on:
  release:
    types: [published]
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq and curl
        run: sudo apt-get update -y && sudo apt-get install -y jq curl

      # 1) Telegram ì‹œí¬ë¦¿ í™•ì¸
      - name: Validate Telegram Secrets
        run: |
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "::error::Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID"
            exit 1
          fi

      # 2) ì´ë²¤íŠ¸ ìœ í˜•ë³„ ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¤€ë¹„
      - name: Prepare release payload
        id: rel
        env:
          EVENT: ${{ github.event_name }}
        run: |
          set -e
          if [ "$EVENT" = "release" ]; then
            TAG='${{ github.event.release.tag_name }}'
            URL='${{ github.event.release.html_url }}'
            DATE='${{ github.event.release.published_at }}'
            BODY_RAW='${{ github.event.release.body }}'
          else
            RES=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases/latest)
            TAG=$(echo "$RES" | jq -r .tag_name)
            URL=$(echo "$RES" | jq -r .html_url)
            DATE=$(echo "$RES" | jq -r .published_at)
            BODY_RAW=$(echo "$RES" | jq -r .body)
          fi

          DATE_SHORT=$(echo "$DATE" | cut -dT -f1)
          # HTML íƒœê·¸ ì´ìŠ¤ì¼€ì´í”„ ë° ë³¸ë¬¸ ìš”ì•½ (í…”ë ˆê·¸ë¨ ì „ì†¡ìš©)
          BODY_SAFE=$(printf "%s" "$BODY_RAW" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' | head -c 1000)

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "date=$DATE_SHORT" >> "$GITHUB_OUTPUT"
          {
            echo "body<<__REL_BODY__"
            printf '%s\n' "$BODY_SAFE"
            echo "__REL_BODY__"
          } >> "$GITHUB_OUTPUT"

      # 3) npm dist-tags ì¡°íšŒ
      - name: Fetch npm dist-tags
        id: dist
        run: |
          JSON=$(curl -s https://registry.npmjs.org/-/package/n8n/dist-tags)
          echo "latest=$(echo "$JSON" | jq -r .latest)" >> "$GITHUB_OUTPUT"
          echo "next=$(echo "$JSON" | jq -r .next)" >> "$GITHUB_OUTPUT"

      # 4) ì¤‘ë³µ ì „ì†¡ ë°©ì§€ ë¡œì§
      - name: Read previous tag
        id: prev
        run: |
          FILE=".github/n8n_latest"
          [ -f "$FILE" ] && PREV=$(cat "$FILE") || PREV=""
          echo "prev=$PREV" >> "$GITHUB_OUTPUT"

      - name: Decide sending
        id: decide
        env:
          EVENT: ${{ github.event_name }}
          PREV: ${{ steps.prev.outputs.prev }}
          CURR: ${{ steps.rel.outputs.tag }}
        run: |
          CHANGED="false"; [ "$PREV" != "$CURR" ] && CHANGED="true"
          if [ "$EVENT" = "release" ] || [ "$EVENT" = "workflow_dispatch" ] || [ "$CHANGED" = "true" ]; then
            echo "should_send=true" >> "$GITHUB_OUTPUT"
          fi
          [ "$EVENT" != "workflow_dispatch" ] && echo "update_tag=1" >> "$GITHUB_OUTPUT" || echo "update_tag=0" >> "$GITHUB_OUTPUT"

      # 5) Telegram ì „ì†¡ (HTML ëª¨ë“œ ì‚¬ìš©)
      - name: Send to Telegram
        if: steps.decide.outputs.should_send == 'true'
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TAG: ${{ steps.rel.outputs.tag }}
          URL: ${{ steps.rel.outputs.url }}
          DATE: ${{ steps.rel.outputs.date }}
          BODY: ${{ steps.rel.outputs.body }}
          LATEST: ${{ steps.dist.outputs.latest }}
          NEXT: ${{ steps.dist.outputs.next }}
        run: |
          MSG="ğŸš€ <b>n8n ì‹ ê·œ ë²„ì „ ì¶œì‹œ!</b> ($DATE)%0A%0A"
          MSG="$MSG<b>Version:</b> <a href='$URL'>$TAG</a>%0A"
          MSG="$MSG<b>Latest:</b> <code>$LATEST</code> | <b>Next:</b> <code>$NEXT</code>%0A%0A"
          MSG="$MSG<b>ì£¼ìš” ë³€ê²½ ì‚¬í•­:</b>%0A<code>$BODY</code>"
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID" \
            -d "parse_mode=HTML" \
            -d "text=$MSG" \
            -d "disable_web_page_preview=false"

      # 6) ê¸°ë¡ ê°±ì‹ 
      - name: Update last sent tag
        if: steps.decide.outputs.update_tag == '1'
        run: |
          mkdir -p .github
          echo "${{ steps.rel.outputs.tag }}" > .github/n8n_latest
          git config user.name "actions-bot"
          git config user.email "actions-bot@users.noreply.github.com"
          git add .github/n8n_latest
          git commit -m "chore: update latest n8n tag to ${{ steps.rel.outputs.tag }}" || exit 0
          git push || exit 0
